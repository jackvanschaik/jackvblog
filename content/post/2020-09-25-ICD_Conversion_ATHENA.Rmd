---
title: "Reproducible ICD Conversion With ATHENA and R"
author: "Jack VanSchaik"
date: 2020-09-22
categories: ["R" , "EHR"]
tags: ["R Markdown", "R", "OMOP", "ICD", "OHDSI", "tidyverse"]
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Why Bother?

If you work with diagnosis data, you're likely to encounter ICD codes. ICD (Internal Classification of Diseases) is a globally used set codes that hierarchically classifies diagnoses, symptoms, and other clinical observations. Since the adoption of the Electronic Health Records (EHR), the primary revision of ICD in use ICD-9. At least, that was so until October 1st, 2015, when the United States made a nationwide switch to ICD-10.

There are some benefits to using ICD-10. For example, it's more specific. If you're doing research however, you can encounter both coding systems in your data. Study periods that include October 1st 2015 will most likely include ICD-9 and ICD-10. This can be problematic for an analysis, so it's often beneficial to convert one or the other ICD codes. This article walks through how to do that. Before we run through our methodology, why are we using it?

* __Reproducibility: __ Reproducibility is a pillar of good research. Sites like [icd10data](https://www.icd10data.com/) can be a good reference, but copying and pasting codes from a website is prone to human error and rarely reproducible. 

* __ATHENA: __ This is the OHDSI vocabulary repository, and includes ICD-9, ICD-10, and mapping between them. There are several ways to convert ICD codes-- this happens to be my favorite because it's open source, easy to understand, and plays nice with relational data. Not to mention, the OHDSI has an engaged community.

* __R : __ In order to be reproducible, we need to do conversions programmatically. A dataset may contain thousands of different ICD codes, making programmatic conversion the only option. R's `tidyverse` makes using ATHENA very easy. In principle, creating a mapping table with ATHENA can and using it programmatically can be applied in other languages.

## Step 1: Get the Athena tables

First, follow the steps in [this article](https://web.jackv.xyz/2020/09/22/how-to-create-a-practice-omop-dataset-in-r/) to download the ATHENA tables for ICD-9 and ICD-10. We'll be using the [CONCEPT](https://github.com/OHDSI/CommonDataModel/wiki/CONCEPT) and [CONCEPT_RELATIONSHIP](https://github.com/OHDSI/CommonDataModel/wiki/CONCEPT_RELATIONSHIP) tables. (Links to documention on the [OHDSI Wiki](https://github.com/OHDSI/CommonDataModel))

## Step 2: Create the Mapping Table

#### Load the ATHENA Tables into R

```{r}
library(tidyverse)
```


```{r}
concept <- read_tsv("C:/Users/Jack/Documents/data/vocabulary_download_v5/CONCEPT.csv", quote="")
concept_relationship <- read_tsv("C:/Users/Jack/Documents/data/vocabulary_download_v5/CONCEPT_RELATIONSHIP.csv", quote="")
```

#### Link concept ids to code names

The concepts from ATHENA are all mapped to an internal `concept_id`. We'll need to map these to our ICD-9 and ICD-10 code names

```{r}
concept %>%
    filter(vocabulary_id == "ICD9CM") %>%
    select(
        icd9_concept_id = concept_id, 
        icd9_name=concept_name, 
        icd9_code=concept_code
    ) ->
    icd_9_concepts

concept %>%
    filter(vocabulary_id == "ICD10CM") %>%
    select(
        icd10_concept_id=concept_id, 
        icd10_name=concept_name, 
        icd10_code=concept_code
    ) ->
    icd_10_concepts

```

#### Map the code systems via CONCEPT_RELATIONSHIP

Each row in the `CONCEPT_RELATIONSHIP` tables represent a concept mapping. Mappings should be read as `concept_id_1` `relationship_id` `concept_id_2`. See below:

```{r}
DT::datatable(head(concept_relationship))
```

ATHENA doesn't have a direct mapping between ICD-9 and ICD-10, so we'll need to do an intermediate mapping between the ICD code systems and ATHENA's standard vocabulary for diagnoses: SNOMED. This involves a few relational joins, so we can use `dplyr` here:

```{r}
#First, lets modify concept_relationship to includes vocabulary_ids

concept_relationship %>%
    select(concept_id_1, relationship_id, concept_id_2) %>%
    left_join(concept, by=c("concept_id_1" = "concept_id")) %>%
    select(concept_id_1, vocabulary_id_1 = vocabulary_id, relationship_id, concept_id_2) %>%
    left_join(concept, by=c("concept_id_2" = "concept_id")) %>%
    select(concept_id_1, vocabulary_id_1, relationship_id, concept_id_2,
           vocabulary_id_2 = vocabulary_id) ->
    concept_relationship

# Next, create the map from ICD 10 to SNOMED
concept_relationship %>%
    filter(vocabulary_id_1 == "ICD10CM") %>%
    filter(vocabulary_id_2 == "SNOMED") %>%
    filter(relationship_id == "Maps to") %>%
    select(
        icd10_concept_id = concept_id_1,
        snomed_concept_id = concept_id_2
    ) ->
    icd10_to_snomed

# Then, the SNOMED to ICD 9 Map
concept_relationship %>%
    filter(vocabulary_id_1 == "ICD9CM") %>%
    filter(vocabulary_id_2 == "SNOMED") %>%
    filter(relationship_id == "Maps to") %>%
    select(
        icd9_concept_id = concept_id_1,
        snomed_concept_id = concept_id_2
    ) ->
    icd9_to_snomed

# Combine everything together
icd_10_concepts %>%
    inner_join(icd10_to_snomed, by="icd10_concept_id") %>%
    inner_join(icd9_to_snomed, by="snomed_concept_id") %>%
    inner_join(icd_9_concepts, by="icd9_concept_id") %>%
    select(icd10_code, icd9_code, icd10_name, icd9_name) ->
    icd10_to_icd9
```

## Step 3: Futher considerations

You now have a mapping table (`icd10_to_icd9`) that you can use to convert between code systems.

```{r}
DT::datatable(head(icd10_to_icd9, n=50))
```

For the sake of this reproducibility save this table as an RDS or csv. When it comes time to use it, you can load back in and join to it with dplyr, programmatically converting the codes. 

Note there isn't always a one-to-one mapping between code systems. 

At this point, you'll need to think critically about the implications of mappings in your own dataset. There might be some situations where a many-to-many mapping is fine: e.g., you want to see if a patient has _any_ diagnoses for a certain disease. There may be cases where a mapping should be more fine grained. Remember no mapping isn't perfect. ICD-10 is pretty much an overhaul of ICD-9 in the first place. While mapping is sometimes a necessity, it will have deficiencies that should be carefully considered.


## Session Info

```{r}
session_info()
```


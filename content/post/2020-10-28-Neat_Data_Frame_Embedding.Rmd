---
title: "Neatly Embedding R Data Frames via JavaScript"
author: "Jack VanSchaik"
description: "Embed R data frames in web pages via JavaScript and json"
date: 2020-10-128
categories: ["R"]
tags: ["R Markdown", "R", "JavaScript"]
twitterImg: /images/jscars.png
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Introduction

I'm a big fan of reproducible and transparent analysis. By using Rmarkdown, R code and most output can be embedded in an html file. 

## Data Frames in Javascript

Javascript doesn't have a built in data frame object type. Instead, it has JSON (JavaScript Object Notation) which is a bit more flexible than R data frames in the sense that it doesn't require rectangular data. As text, JSON stores data. In the context of JavaScript code, JSON defines an object.

A pretty common format for storing data frames in JSON is to use an array of objects. Here's an example in JavaScript:

```{js}
data_js = [
    {col_name: "a", col_2: 1},
    {col_name: "b", col_2: 2},
    {col_name: "c", col_2: 3}
]
```

And the analogous R code:

```{r}
data_r <- data.frame(
    col_name = c("a", "b", "c"),
    col_2 = 1:3
)
```

It may be useful to embed an R dataframe in a Rmarkdown web page. Perhaps you want to offer some type of interactivity via javascript on a static web page, or just want to be as transparent as possible. Either way this is possible as long as the data isn't unreasonable big.

Furthermore, JSON doesn't the same concept of columns as an R data frame. We could restructure the object entirely, but JavaScript libraries often use the format define above. The following codes allows you to embed R data frames in your markdown html files and extract columns in a familiar way by using `.` instead of the familiar `$` in R. 

## JavaScript Code

We need two functions:

`DataFrame`: This is an object constructor for our data frame class in JavaScript. It takes data in the format described above and has some object for automatically detectinc columns names if they aren't suppied.
`as_DataFrame`: This is a wrapper around `DataFrame` that creates a [proxy](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy) for a new data frame object. We can use the proxy to modify the behavior of the `.` operator for the object. Normally, the `.` would access object attributes, but here we've modified it to access columns in meaningful way without changing the underlying object structure.

```{js}
function DataFrame(data, names="") {
    this.data = data;
    var col_names;
    if (names === "") {
        this.col_names = Array(0);
        for (var x in data[0]) {
            this.col_names.push(x);
        }
    }
    else {
        this.col_names = names;
    }
}

function as_DataFrame(data, names="") {
    var DF = new DataFrame(data, names);
    var handler = {
        get : function(target, prop, receiver) {
            if (target.col_names.includes(prop)) {
                var x = Array(0);
                for (var r in target.data) {
                    x.push(target.data[r][prop]);
                }
                return(x);
            }
            else {
                return(Reflect.get(...arguments));
            }
        }
    };
    var proxy = new Proxy(DF, handler);
    return(proxy);
}
```

## R Code

Here's the R function to embed data frames.

```{r}
embed_df <- function(df) {
    var_name <- as.character(substitute(df)) # Get name of argument
    json <- as.character(jsonlite::toJSON(df)) # Convert data frame to JSON text
    js_code <- sprintf("%s = as_DataFrame(%s);", var_name, json) # Write JavaScript code 
    htmltools::tags$script(js_code) # Run the code in the document via a <script> tag
}

```

Now we just call our function on the data frame we want to embed:

```{r}
embed_df(mtcars)
```

Now, we can test it out in javascript. This document runs the following code:

```{js}
console.log(mtcars)
console.log(mtcars.data)
console.log(mtcars.mpg)
```

Check your javascript console to see what happened! (Ctrl + Shift + J in Chrome)

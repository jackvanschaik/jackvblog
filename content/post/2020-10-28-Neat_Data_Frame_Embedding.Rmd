---
title: "Neatly Embedding R Data Frames via JavaScript"
author: "Jack VanSchaik"
description: "Embed R data frames in web pages via JavaScript and json"
date: 2020-10-28
categories: ["R"]
tags: ["R Markdown", "R", "JavaScript"]
twitterImg: /images/jscars.png
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

R users can publish their analysis and results to the web with Rmarkdown, Shiny, and a whole host of R packages. In the interest of reproducibility and transparency, this post offers a method of embedding R data frames in a web page created by Rmarkdown. 

Why? You want to supply your data to some javascript library or directly to the users. This should be easy enough if the data isn't too big. While Shiny makes this easier, the user may be limited to static web pages. 

JSON doesn't the same concept of columns as an R data frame. We could restructure the object entirely, but JavaScript libraries often use a particular JSON format for rectangular data. The following code allows you to embed R data frames in your markdown html files and extract columns in a familiar way by using `.`-- quite like the familiar `$` in R. 

## Data Frames in Javascript

Javascript doesn't have a built in data frame object. It does have has [JSON (JavaScript Object Notation)](https://www.w3schools.com/js/js_json_intro.asp), which is a bit more flexible. In the context of JavaScript code, JSON defines an object. Anywhere else, it's a storage format. 

A standard format for storing data frames in JSON is to use an array of objects. Here's an example in JavaScript:

```{js}
// this saves the object to a variable called "data_js"
// the actual JSON is the "[...]" component
data_js = [
    {col_name: "a", col_2: 1},
    {col_name: "b", col_2: 2},
    {col_name: "c", col_2: 3}
]
;
```

... and here's the analogous R code:

```{r}
data_r <- data.frame(
    col_name = c("a", "b", "c"),
    col_2 = 1:3
)
```

## JavaScript Code

We need two functions:

* `DataFrame`: This is an object constructor for our data frame class in JavaScript. It takes data in the format described above and has some object for automatically detecting columns names if they aren't supplied.
* `as_DataFrame`: This is a wrapper around `DataFrame` that creates a [proxy](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy) for a new data frame object. We can use the proxy to modify the behavior of the `.` operator for the object. Normally, the `.` would access object attributes, but here we've modified it to access columns in meaningful way without changing the underlying object structure.

```{js}
function DataFrame(data, names="") {
    this.data = data;
    var col_names;
    if (names === "") {
        this.col_names = Array(0);
        for (var x in data[0]) {
            this.col_names.push(x);
        }
    }
    else {
        this.col_names = names;
    }
}

function as_DataFrame(data, names="") {
    var DF = new DataFrame(data, names);
    var handler = {
        get : function(target, prop, receiver) {
            if (target.col_names.includes(prop)) {
                var x = Array(0);
                for (var r in target.data) {
                    x.push(target.data[r][prop]);
                }
                return(x);
            }
            else {
                return(Reflect.get(...arguments));
            }
        }
    };
    var proxy = new Proxy(DF, handler);
    return(proxy);
}
```

## R Code

Here's the R function to embed data frames.

```{r}
embed_df <- function(df) {
    var_name <- as.character(substitute(df)) # Get name of argument
    json <- as.character(jsonlite::toJSON(df)) # Convert data frame to JSON text
    js_code <- sprintf("%s = as_DataFrame(%s);", var_name, json) # Write JavaScript code 
    htmltools::tags$script(js_code) # Run the code in the document via a <script> tag
}

```

Now we just call our function on the data frame we want to embed:

```{r}
embed_df(mtcars)
```

Now, we can test it out in javascript. This document runs the following code:

```{js}
console.log(mtcars)
console.log(mtcars.data)
console.log(mtcars.mpg)
```

Check your javascript console to see what happened! (Ctrl + Shift + J in Chrome)

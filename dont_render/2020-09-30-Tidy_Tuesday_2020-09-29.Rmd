---
title: "Tidy Tuesday 9-29-2020"
author: "Jack VanSchaik"
description: "Which words are worth the most?"
date: 2020-09-29
categories: ["TidyTuesday"]
tags: ["R Markdown", "R", "TidyTuesday", "Tidyverse"]
twitterImg: /images/beyonce.png
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Packages

* `beyonce`: Load [Beyonce themed color palettes](https://github.com/dill/beyonce)
* `gridExtra`: To arrange visualizations
* `knitr`: For nice data frame printing
* `rvest`: For webscraping
* `scales`: To help with plots
* `tidytext`: To do text processing
* `tidyverse`: For data cleaning and plotting
* `tidytuesdayR`: To load the Tidy Tuesday data

```{r, results="hide", message=FALSE}
library(beyonce)
library(gridExtra)
library(knitr)
library(rvest)
library(scales)
library(tidytext)
library(tidytuesdayR)
library(tidyverse)
```

## Load Data

Following the instructions on the [Tidy Tuesday Github](https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-09-29/readme.md):

```{r}
tuesdata <- tidytuesdayR::tt_load('2020-09-29')
```
I'll put the tables in my global environment:

```{r}
beyonce_lyrics <- tuesdata$beyonce_lyrics
taylor_swift_lyrics <- tuesdata$taylor_swift_lyrics
sales <- tuesdata$sales
charts <- tuesdata$charts
```

## What's the Value of a Lyric?

There's no way to really know this for certain. We can simplify things a little by assuming each word in an album contributes equally to the value it generates, and by further assuming the value of each song is determined completely by its lyrics. We'll ignore common grammatical words (stopwords) in this analysis, as those are pretty universal.

#### Make a text cleaning function

Since we'll be cleaning text in a few different place, let's make a function to standardize this:

```{r}
clean_tokens <- function(tokens) {
    tokens %>%
        tolower() %>%
        str_replace_all("[^[\\w[[:space:]]]]+", "") %>%
        str_squish() ->
        tokens_clean
    
    tokens_clean
}
```


#### Tidy the song lyrics

The `tidytext` format means using one word per row. Let's clean up the lyrics tables for each of the singers. To do this, we'll need to use `unnest_tokens` from the `tidytext` package. 

For each set of lyrics, we'll do the following cleaning steps:

* Unnest tokens and lowercase
* Clean text
* Remove stopwords


First, let's define our stopwords as those in `tidytexts`'s `stop_words` in the `snowball` lexicon. We'll remove punctuation to match with our text cleaning.

```{r}
stop_words %>%
    filter(lexicon == "snowball") %>%
    mutate(word = clean_tokens(word)) %>%
    pull(word) ->
    lyric_stop_words

head(lyric_stop_words)
```
Cleaning Beyonce's lyrics:

```{r}
beyonce_lyrics %>%
    select(artist_name, song_name, line) %>%
    unnest_tokens(words, line) %>%
    mutate(
        words = clean_tokens(words),
        song_name = clean_tokens(song_name)
    ) %>%
    filter(!(words %in% lyric_stop_words)) ->
    beyonce_tidytext
```

Cleaning Taylor's lyrics. I had an issue with column names so I used `janitor` to clean them.

```{r}
taylor_swift_lyrics %>%
    janitor::clean_names() %>%
    select(artist_name=artist, song_name=title, album, lyrics) %>%
    unnest_tokens(words, lyrics) %>%
    mutate(
        words = clean_tokens(words),
        song_name = clean_tokens(song_name),
        album = clean_tokens(album)
    ) %>%
    filter(!(words %in% lyric_stop_words)) ->
    taylor_tidytext
```

#### Get Album Names for Beyonce's songs

The `beyonce_lyrics` table we got from `tidytuesdayR` doesn't include album names.

We can scrape those from wikipedia, similar to what we saw in the cleaning script. We'll have to do some cleaning

```{r}
bey_url <- "https://en.wikipedia.org/wiki/List_of_songs_recorded_by_Beyonc%C3%A9"
bey_html <- read_html(bey_url)

bey_html %>%
    html_node(xpath = "/html/body/div[3]/div[3]/div[5]/div[1]/table[2]") %>% 
    html_table(fill = TRUE) %>% 
    tibble %>%
    janitor::clean_names() %>%
    transmute(artist_name="Beyoncé", song_name = song, album = originating_album_note_1) %>%
    mutate(song_name = str_replace_all(song_name, "\\[[\\w ]+\\]", "")) %>%
    mutate(
        song_name = clean_tokens(song_name),
        album = clean_tokens(album)
    ) ->
    bey_albums
```


#### Match each song to it's sales value

First, let's limit to US sales so we're comparing apples to apples. Let's also clean album names.

```{r}
sales %>%
    filter(country == "US") %>%
    transmute(
        artist_name = artist,
        album = clean_tokens(title),
        sales
    ) ->
    sales_2
```

Now let's join each lyric to it's album worth. First, Beyonce. We'll remove any albums without sales data:

```{r}
beyonce_tidytext %>%
    left_join(bey_albums, by=c("artist_name", "song_name")) %>%
    left_join(sales_2, by=c("artist_name", "album")) %>%
    filter(!is.na(sales)) ->
    bey_joined
```

Next, Taylor

```{r}
taylor_tidytext %>%
    left_join(sales_2, by=c("artist_name", "album")) %>%
    filter(!is.na(sales)) ->
    taylor_joined
```

Finally, let's union the tables together

```{r}
lyrics_joined <- bind_rows(bey_joined, taylor_joined)
```

#### Create a value for each word

Again, we'll divide the worth of an album among all it's words. If a word appears multiple times and/or across multiple albums, we'll add the total values up.

```{r}
lyrics_joined %>%
    group_by(artist_name, album) %>%
    mutate(total_words = length(words)) %>%
    mutate(word_value = sales/total_words) %>%
    group_by(artist_name, words) %>%
    summarise(total_word_value = sum(word_value)) ->
    word_values
```
## Visualization

Now that we finally have our word values, let's visualize!

#### Top 15 most valuable words for each artist

```{r}
word_values %>%
    group_by(artist_name) %>%
    arrange(artist_name, desc(total_word_value)) %>%
    filter(row_number() < 15) ->
    top_15
```


Create a theme based on the `beyonce` package:

```{r}
bey_theme <- function(N) {
    theme(legend.position = "none", 
          axis.text.y = element_blank(), 
          axis.ticks = element_blank(),
          plot.background = element_rect(fill = beyonce_palette(N)[5]),
          panel.background = element_rect(fill = beyonce_palette(N)[4], colour = beyonce_palette(N)[4]),
          panel.grid.major.y = element_blank(), panel.grid.minor.y = element_blank(),
          panel.grid.major.x = element_line(color = beyonce_palette(N)[3], linetype=3),
          panel.grid.minor.x = element_blank(),
          text = element_text(color=beyonce_palette(N)[1], family = "sans"),
          rect = element_rect(color=beyonce_palette(N)[2]),
          title = element_text(color=beyonce_palette(N)[1])
          )
}
```


```{r}
plot_1 <- top_15 %>% 
    filter(artist_name=="Beyoncé") %>%
    arrange(total_word_value) %>%
    mutate(words=factor(words, levels=words)) %>%
    ggplot(aes(x=words, y=total_word_value, label=words)) + 
    geom_bar(stat="identity", color = beyonce_palette(50)[1], fill = beyonce_palette(50)[1]) +
    geom_text(nudge_y = 50000, color = beyonce_palette(50)[1]) + 
    coord_flip() + 
    labs(title="Beyoncé's Most Valuable Words", y="Total Word Value", x="Top 15 Most Valuable Words") +
    scale_y_continuous(labels = comma, limits = c(0, 600000)) + 
    bey_theme(50)

plot_2 <- top_15 %>% 
    filter(artist_name=="Taylor Swift") %>%
    arrange(total_word_value) %>%
    mutate(words=factor(words, levels=words)) %>%
    ggplot(aes(x=words, y=total_word_value, label=words)) + 
    geom_bar(stat="identity", color = beyonce_palette(50)[1], fill = beyonce_palette(50)[1]) +
    geom_text(nudge_y = 50000, color = beyonce_palette(50)[1]) + 
    coord_flip() +
    labs(title="Taylor Swift's Most Valuable Words", y="Total Word Value", x="") + 
    scale_y_continuous(labels = comma, limits = c(0, 600000)) + 
    bey_theme(50)

grid.arrange(plot_1, plot_2, ncol=2)
```

Looks like they have the same top three most valuable words! In a way, this is almost a surrogate for most popular words. There are still some interesting differences and similarities

## Acknowldegements

Thanks to Rosie Baillie and Dr. Sara Stoudt for putting this weeks data together. Thanks to the Tidy Tuesday team and package developers for making this possible.

## Session Info

```{r}
session_info()
```

